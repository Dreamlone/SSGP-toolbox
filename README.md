# SSGP-toolbox

SimpleSpatialGapfiller --- класс, позволяющий заполнять пропуски в матрицах на основе методов машинного обучения


## Requirements
    'gdal==2.4',
    'numpy',
    'scikit-learn==0.21.3',
    'pandas',
    'scipy',
    'netCDF4',
    'pyproj' 

## Установка модуля со всеми зависимостями


```python
pip install git+https://github.com/Dreamlone/SSGP-toolbox
```

## Подготовка данных

Для корректной работы алгоритма необходимо подготовить обучающую выборку и данные для заполнения пропусков.
Формируется директория (LST, NDVI или любое другое название, которое пользователь может задать самостоятельно), в которой расположены папки (названия папок фиксированы): 

![Database.png](https://raw.githubusercontent.com/Dreamlone/SSGP-toolbox/master/Supplementary/images/rm_1_Database.png)

### 1. History - папка с матрицами в формате .npy (бинарный формат), которые являются обучающей выборкой.

Названия файлов должны быть формата - "20190625T185030.npy", где 2019.. - год, ..06.. - месяц, ..25.. - день, ..T185030 - время - часы минуты секунды (format = '%Y%m%dT%H%M%S'). Матрицы в обучающей выборке могут содержать пропуски. При обучении алгоритм будет либо удалять эти пропуски из обучающей выборки, либо заменять их медианой по временному ряду для данного пикселя.


### 2. Inputs - папка с имеющими пропуски матрицами в формате .npy (бинарный формат), которые необходимо заполнить.

Названия файлов должны быть формата - "20190625T185030.npy", где 2019.. - год, ..06.. - месяц, ..25.. - день, ..T185030 - время - часы минуты секунды (format = '%Y%m%dT%H%M%S')

### 3. Extra - папка с матрицей в формате .npy (бинарный формат), которая позволяет разделить ячейки матриц на группы. Название файла должно быть формата - "Extra.npy"

Матрица может выглядеть следующим образом:
![Biomes.png](attachment:https://github.com/Dreamlone/SSGP-toolbox/Supplementary/images/rm_2_Biomes.png)

В качестве значений в данной матрице должны быть записаны целые числа.

## Значения в матрицах

1) -100.0 - значение в пикселях, которые необходимо заполнить

2) -200.0 - NoData в пикселях, которые заполнять не нужно, например, морская вода, когда заполнять следует только пиксели со значениями температуры поверхности земли. Алгоритм будет ретроспективно оценивать, был ли каждый конкретный пиксель занять значением -200.0, и если был, то предсказанное моделью значение в данном пикселе будет равно -200.0.

3) -32768.0 - значение в пикселях, которые не попали в экстенд снимка, также данным значением могут быть помечены ошибки при проецировании растровых изображений. Если количество пикселей с данным значением в матрице из папки 'History' превышает 5 процентов на снимке, то данная матрица не будет включена в обучающую выборку

Алгоритм заполняет только пиксели со значениями -100.0.


В случае, если матрица, которую необходимо заполнить, имеет менее 101 незакрытого пикселя (то есть НЕ '-100', НЕ '-200' и НЕ '-32768'), то алгоритм её не заполняет, на экран выводится сообщение 'No calculation for matrix NAME_OF_MATRIX'. Матрица не добавляется в папу "Outputs".


Если матрица не имеет пропусков, то на экране появится сообщение 'No gaps in matrix NAME_OF_MATRIX'. Матрица автоматически добавляется в папу "Outputs".


Таким образом:
- Обучающая выборка размещается в папке "History"
- Матрицы, которые необходимо заполнить, следует разместить в папке "Inputs"
- Папка "Extra" является опциональной и в случае создания содержит одну матрицу
- Папка "Outputs" формируется во время работы алгоритма

В результате работы алгоритма формируется папка 'Outputs', в которой заполненные алгоритмом матрицы сохраняются в формате .npy, а также создается файл .json со значенями оценки точности работы алгоритма для каждого слоя. Точность оценивается по кросс-валидации на данных из обучающей выборки.

## Examples

Выбранный метод - метод опорных векторов. Стратегия выбора предикторов - "биомы". Подбор гиперпараметров - пользовательская настройка в виде словаря. 


```python
Gapfiller = SpatialGapfiller(directory = '/media/test/LST')
Gapfiller.filling_gaps(method = 'SVM', predictor_configuration = 'Biome',
                       hyperparameters = 'Custom', 
                       params = {'kernel': 'linear', 'gamma': 'scale', 'C': 1000, 'epsilon': 1})
```

Пример применения алгоритма. Выбранный метод - LASSO регрессия. Стратегия выбора предикторов - "случайные 100 точек". Подбор гиперпараметров - полный поиск по сетке. Заполненные алгоритмом матрицы будут включаться в обучающую выборку для последующих слоев.


```python
Gapfiller = SpatialGapfiller(directory = '/media/test/LST')
Gapfiller.filling_gaps(method = 'Lasso', predictor_configuration = 'Random',
                       hyperparameters = 'GridSearch', add_outputs = True)
```

## Theoretical basis

Алгоритм опирается на значения в известных пикселях той же матрицы, что и пропуск, для того, чтобы расчитать значение в пропуске.
### Принцип работы

Алгоритм строит отдельно для каждого пикселя свою модель, затем в зависимости от заданных параметров применяет различные способы подбора предикторов. На иллюстрации приведен упрощенный пример того, как алгоритм формирует обучающую выборку.
![Construction.png](attachment:https://github.com/Dreamlone/SSGP-toolbox/Supplementary/images/rm_3_Construction.png)

Программная реализация содержит 1 класс - SpatialGapfiller().
#### Приватные методы:
- __make_training_sample  --- формирование обучающей выборки из матриц в папке "History"
- __learning_and_fill     --- заполнение пропусков на конкретной матрице, запись результата в папку "Outputs"

#### Публичные методы:
- filling_gaps            --- применение метода __learning_and_fill для каждой из матриц в папке "Inputs", создание файла с метаданными о качестве работы алгоритма

По результатам проведенных экспериментов с моделью, установлено, что временная сложность алгоритма сублинейная.

![Complexity.png](attachment:https://github.com/Dreamlone/SSGP-toolbox/Supplementary/images/rm_4_Complexity.png)

Для алгоритма была прозведена верефикация на тепловых данных дистанционного зондирования со спутниковой системы Sentinel-3. Были отобраны 6 разновременных снимков одной территории. Для каждого из 6 снимков генерировался пропуск определенного размера и формы. Всего было сгенерировано 8 типов пропусков. Результаты проведенных тестов можно увидеть ниже. В болшинстве случаев алгоритм ошибался менее чем на 1 градус, при том, что средний разброс значений температуры в пропуске составлял около 10.

![Results.png](attachment:https://github.com/Dreamlone/SSGP-toolbox/Supplementary/images/rm_5_Results.png)

## Параметры


### Выбор алгоритма заполнения пропусков - method
- ПО УМОЛЧАНИЮ 'Lasso' - Лассо регрессия 
- 'RandomForest' - случайный лес
- 'ExtraTrees' - сверхслуйчаный лес
- 'Knn' - k-ближайших соседей
- 'SVM' - метод опорных векторов

### Стратегии подбора предикторов - predictor_configuration
- ПО УМОЛЧАНИЮ 'Random' - Случано выбранные 100 точек на снимке
- 'All' - предикторы - все известные точки на снимке
- 'Biome' - в качестве предикторов выбираются 40 наиболее близких (по Евклидовой метрике) пикселей из того же биома, что и пропуск

### Варианты настройки гиперпараметров - hyperparameters
- ПО УМОЛЧАНИЮ 'RandomGridSearch' - случайный поиск по сетке 
- 'GridSearch' - полный перебор по сетке
- 'Custom' - пользовательская настройка в виде словаря

### Словарь с гиперпараметрами (если hyperparameters = 'Custom') - params
- ПО УМОЛЧАНИЮ - None. Если hyperparameters != 'Custom', то игнорируется

### Возможность использования заполненных слоев - add_outputs
- ПО УМОЛЧАНИЮ - False, т.е. заполненные слои не добавляются в обучающую выборку
- True - в таком случае заполненные алгоритмом матрицы включаются в обучающую выборку


